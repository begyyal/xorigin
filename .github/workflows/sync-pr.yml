name: Update process of PR

on:
  pull_request:
    branches: [ develop ]
    types: [ opened, synchronize ]

jobs:

  pr-update-process:
    runs-on: ubuntu-latest
    steps:

    - name: Checkout head
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
        submodules: true
        ref: ${{ github.head_ref }}

    - name: Checkout base
      if: ${{ startsWith(github.head_ref, 'feature/') }}
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
        submodules: true
        ref: ${{ github.base_ref }}
        path: ./temp

    - name: Create snapshot-from
      if: ${{ startsWith(github.head_ref, 'feature/') }}
      shell: bash
      run: |
        cd ./temp
        branch=${{ github.head_ref }}
        snapshot=ss-from${branch#feature}
        [ -n "$(git branch -r | sed 's/ //g' | grep -e ^origin/$snapshot)" ] && git push origin $snapshot --delete
        git checkout -b $snapshot
        git push origin $snapshot
        cd ../ && rm -rdf ./temp

    - name: Create snapshot-to
      if: ${{ startsWith(github.head_ref, 'feature/') }}
      shell: bash
      run: |
        branch=${{ github.head_ref }}
        snapshot=ss-to${branch#feature}
        [ -n "$(git branch -r | sed 's/ //g' | grep -e ^origin/$snapshot)" ] && git push origin $snapshot --delete
        git checkout -b $snapshot
        git push origin $snapshot

    - name: Prepare conditions
      id: cond
      shell: bash
      run: |
        do_test="$(./.github/workflows/sh/do_test.sh ${{ github.base_ref }} ${{ github.head_ref }})"
        echo "::set-output name=do-test::${do_test}"

    - name: Update submodules
      if: ${{ steps.cond.outputs.do-test }}
      run: git submodule update --remote

    - name: Set up JDK 15
      if: ${{ steps.cond.outputs.do-test }}
      uses: actions/setup-java@v2
      with:
        java-version: '15'
        distribution: 'adopt'

    - name: Grant execute permission for gradlew
      if: ${{ steps.cond.outputs.do-test }}
      run: chmod +x ./cmd/gradlew

    - name: Build with Gradle
      if: ${{ steps.cond.outputs.do-test }}
      run: |
        ./cmd/gradlew build -b ./lib/build.gradle -x test
        ./cmd/gradlew build -b ./cmd/build.gradle -x test

    - name: Test
      if: ${{ steps.cond.outputs.do-test }}
      run: ./test.sh
